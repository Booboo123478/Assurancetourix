<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Mini-articles</title>
  <style>
    #formContainer {
      display: none;
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 10px;
    }
  </style>
</head>
<body>
  <h1>Messages de la communaut√© üó£Ô∏è</h1>

  <button id="toggleFormBtn">‚úçÔ∏è √âcrire un message</button>

  <!-- <div id="formContainer">
    <form action="/posts" method="POST">
      <textarea name="content" placeholder="Votre message" required></textarea><br><br>
      <button type="submit">Publier</button>
    </form>
  </div> -->
  <div id="formContainer">
    <form action="/posts" method="POST" enctype="multipart/form-data">
      <textarea name="content" placeholder="Votre message" required></textarea><br><br>

      <!-- Bouton + pour ouvrir la s√©lection fichier -->
      <button type="button" onclick="document.getElementById('mediaInput').click()">+</button>

      <!-- Champ fichier cach√© -->
      <input type="file" name="media" id="mediaInput" accept="image/*,video/*" style="display:none" onchange="previewMedia()">

      <!-- Aper√ßu du m√©dia s√©lectionn√© -->
      <div id="mediaPreview" style="margin-top:10px;"></div>

      <br><button type="submit">Publier</button>
    </form>
  </div>


  <hr>

  <h2>Messages r√©cents</h2>
  <div id="posts"></div>

  <!-- <script>
    // Afficher/cacher le formulaire
    const toggleBtn = document.getElementById('toggleFormBtn');
    const formContainer = document.getElementById('formContainer');

    toggleBtn.addEventListener('click', () => {
      if (formContainer.style.display === 'none') {
        formContainer.style.display = 'block';
        toggleBtn.textContent = '‚ùå Fermer';
      } else {
        formContainer.style.display = 'none';
        toggleBtn.textContent = '‚úçÔ∏è √âcrire un message';
      }
    });

    // Afficher les messages
    fetch('/posts')
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('posts');
        data.reverse().forEach(post => {
          const div = document.createElement('div');
          div.innerHTML = `<strong>${post.author}</strong> (${new Date(post.date).toLocaleString()})<br>${post.content}<hr>`;
          container.appendChild(div);
        });
      });
  </script> -->

  <script>
  // Afficher/cacher le formulaire
  const toggleBtn = document.getElementById('toggleFormBtn');
  const formContainer = document.getElementById('formContainer');

  toggleBtn.addEventListener('click', () => {
    if (formContainer.style.display === 'none' || formContainer.style.display === '') {
      formContainer.style.display = 'block';
      toggleBtn.textContent = '‚ùå Fermer';
    } else {
      formContainer.style.display = 'none';
      toggleBtn.textContent = '‚úçÔ∏è √âcrire un message';
    }
  });

  // Afficher les messages avec gestion multim√©dia
  fetch('/posts')
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('posts');
      container.innerHTML = '';  // vide avant d‚Äôafficher
      data.reverse().forEach(post => {
        const div = document.createElement('div');

        // Pr√©paration du m√©dia
        let mediaHTML = '';
        if (post.media) {
          const ext = post.media.split('.').pop().toLowerCase();
          if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
            mediaHTML = `<br><img src="/uploads/${post.media}" width="300" alt="media">`;
          } else if (['mp4', 'webm', 'ogg'].includes(ext)) {
            mediaHTML = `<br><video controls width="300"><source src="/uploads/${post.media}" type="video/${ext}"></video>`;
          }
        }

        div.innerHTML = `
          <strong>${post.author || 'Anonyme'}</strong> 
          (${new Date(post.date).toLocaleString()})<br>
          ${post.content}
          ${mediaHTML}
          <hr>
        `;
        container.appendChild(div);
      });
    })
    .catch(err => console.error('Erreur chargement posts:', err));

  // Fonction d‚Äôaper√ßu m√©dia dans le formulaire
  function previewMedia() {
    const input = document.getElementById('mediaInput');
    const preview = document.getElementById('mediaPreview');
    preview.innerHTML = '';

    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      if (file.type.startsWith('image/')) {
        preview.innerHTML = `<img src="${e.target.result}" width="200" alt="Aper√ßu image">`;
      } else if (file.type.startsWith('video/')) {
        preview.innerHTML = `<video controls width="200"><source src="${e.target.result}" type="${file.type}"></video>`;
      } else {
        preview.innerHTML = "Format de fichier non support√© pour l'aper√ßu.";
      }
    };
    reader.readAsDataURL(file);
  }
</script>

</body>
</html>
